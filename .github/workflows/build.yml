name: Build and Deploy Plugins

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # æ£€æŸ¥åœæ­¢æ„å»ºæ–‡ä»¶
    - name: Check for stop_auto_build file
      id: check-stop-file
      run: |
        if [ -f "stop_auto_build" ]; then
          echo "stop_file_exists=true" >> $GITHUB_OUTPUT
        else
          echo "stop_file_exists=false" >> $GITHUB_OUTPUT
        fi

    # æ£€å‡ºä»£ç ï¼ˆä»…å½“éœ€è¦æ„å»ºæ—¶ï¼‰
    - name: Checkout code
      uses: actions/checkout@v4
      if: ${{ steps.check-stop-file.outputs.stop_file_exists == 'false' || github.event_name == 'workflow_dispatch' }}
      with:
        persist-credentials: false

    # è®¾ç½® Node.js ç¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 16
      if: ${{ steps.check-stop-file.outputs.stop_file_exists == 'false' || github.event_name == 'workflow_dispatch' }}

    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: npm ci
      if: ${{ steps.check-stop-file.outputs.stop_file_exists == 'false' || github.event_name == 'workflow_dispatch' }}

    # æ„å»ºæ’ä»¶
    - name: Build plugins
      run: npm run build
      if: ${{ steps.check-stop-file.outputs.stop_file_exists == 'false' || github.event_name == 'workflow_dispatch' }}

    # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°ä»“åº“
    - name: Commit and push dist directory
      if: ${{ (steps.check-stop-file.outputs.stop_file_exists == 'false' || github.event_name == 'workflow_dispatch') && success() }}
      run: |
        # é…ç½® Git ç”¨æˆ·
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ  dist ç›®å½•å¹¶æäº¤
        git add dist
        if git diff-index --quiet HEAD --; then
          echo "No changes in dist directory"
        else
          git commit -m "chore: auto-build plugins [skip ci]"
          git push
        fi

    # è·³è¿‡æ„å»ºçš„é€šçŸ¥
    - name: Skip build notification
      if: ${{ steps.check-stop-file.outputs.stop_file_exists == 'true' && github.event_name != 'workflow_dispatch' }}
      run: echo "ğŸ›‘ Skipping build due to presence of stop_auto_build file"